<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js" type="text/javascript"></script>
  </head>
  <body>
    <span id="messageDisplay"></span>
    <span id="ResultDisplay"></span>
  </body>

  <script type="text/javascript">
    ThunkableWebviewerExtension.receiveMessageWithReturnValue(function(message, callback) {
      document.getElementById('messageDisplay').innerHTML = message;

      // 定义运算符集合
      const operators = ['+', '-', '*', '/', '%', '.', '^'];
      let result = '';

      // 验证输入是否合法
      try {
        // 检查是否以运算符结尾
        if (operators.includes(message[message.length - 1])) {
          throw new Error('Expression ends with an operator');
        }

        // 检查是否包含非法的连续运算符（排除正负数的情况）
        for (let i = 0; i < message.length - 1; i++) {
          if (operators.includes(message[i]) && operators.includes(message[i + 1])) {
            // 允许正负数的情况，如 "1--", "2+-", "2*+", "2/-"
            if (!(message[i] === '-' && message[i + 1] === '-') && 
                !(message[i] === '+' && message[i + 1] === '-') &&
                !(message[i] === '*' && message[i + 1] === '+') &&
                !(message[i] === '/' && message[i + 1] === '-') &&
                !(message[i] === '*' && message[i + 1] === '-') &&
                !(message[i] === '/' && message[i + 1] === '+')) {
              throw new Error('Invalid consecutive operators');
            }
          }
        }

        // 检查除以零的情况
        if (message.includes('/0')) {
          throw new Error('Division by zero');
        }

        // 使用 Function 构造函数来安全地计算表达式
        result = new Function('return ' + message)();

        // 如果结果是数字，则保留两位小数
        if (typeof result === 'number') {
          result = result.toFixed(2);
        }
      } catch (error) {
        // 如果出现错误，返回 "Error"
        result = 'Error';
      }

      // 显示结果
      document.getElementById('ResultDisplay').innerHTML = result;

      // 返回结果
      callback(result);
    });
  </script>
</html>
